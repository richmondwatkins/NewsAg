"use strict"; 
var SummaryTool = require('node-summary');
var textrank = require('textrank-node');
var Tokenizer = require('sentence-tokenizer');


var totalSummaryCount = 3;

class TLDR {

	constructor(title, html) {
		this.title = title;
		this.html = html;
  	}

	getSummary() {
		var scope = this,
			sentenceWordObjs = this.splitIntoSentences(),
			weightedGraph = this.buildWeightedGraph(sentenceWordObjs);

		var totalScores = [];

		sentenceWordObjs.forEach((s, i) => {
			if (weightedGraph[i].length) {
				s.score = weightedGraph[i].reduce((a, b) => a + b);
			}
		});

		var sorted = sentenceWordObjs.sort((o, t) => t.score - o.score);
		var finalSentenceObjs = [];

		if (sorted.length < totalSummaryCount) {
			finalSentenceObjs = sorted;
		} else {
			finalSentenceObjs = sorted.splice(0, 3);
		}

		return finalSentenceObjs.map(f => f.sentence);
	}

	buildWeightedGraph(sentenceWordObjs) {
		var outerWeighted = [];

		sentenceWordObjs.forEach((orig, i) => {
			var innerWeighted = [];

			orig.index = i;

			sentenceWordObjs.forEach((comp, j) => {
				if (i !== j) {

					comp.index = j;

					innerWeighted.push(this.weight(orig, comp));
				}
			});

			outerWeighted.push(innerWeighted);
		});

		return outerWeighted
	}

	splitIntoSentences() {
		var tokenizer = new Tokenizer('');

		tokenizer.setEntry(this.html);

		var tokenSentences = tokenizer.getSentences(),
			sentenceWordLookup = {},
			sentences = [];

		var mutTokenSentences = tokenSentences;

		tokenSentences.forEach((s, i) => {
			var firstWord = tokenizer.getTokens(i)[0];
			if (firstWord === firstWord.toLowerCase() && i > 0) {
				mutTokenSentences[i - 1] = tokenSentences[i - 1] + ' ' + tokenSentences[i];
				mutTokenSentences.splice(i, 1);
			}
		});

		mutTokenSentences.forEach((s, i) => {
			var obj = {};

			obj['sentence'] = s;
			obj['words'] = tokenizer.getTokens(i)
			.map(w => w.toLowerCase()
				.replace(/[^\w\s]|_/g, "")
         		.replace(/\s+/g, " ")
         	).filter(wf => {
         		var upperCase = wf.toUpperCase();

         		for (var i = 0; i < ignoredWords.length; i++) {
         			var iw = ignoredWords[i];

         			if (upperCase === iw) {
         				return false;
         			}
         		}

         		return true;
         	});

			sentences.push(obj);
		});

		return sentences;
	}

	weight(sent1, sent2) {
		var scope = this,
			score = 0;

		sent1['words'].forEach(o => {
			var included = false;
			sent2['words'].forEach(c => {
				if (c == o) {
					included = true;
				}

				score += scope.isInTitle(c) ? 1 : 0;
			});

			score += included ? 1 : 0
		});

		if (sent1.index === 0) {
			score += 5;
		}

		return score / (sent1['words'].length + sent2['words'].length) / 2
	}

	isInTitle(word) {
		// var words = this.title.split(' ');

		// for (var i = 0; i < words.length; i++) {
		// 	var iw = words[i];

		// 	if (word === iw) {
		// 		return true;
		// 	}
		// }

		return false;
	}
}

module.exports = TLDR;



var ignoredWords = ["A",
"ABLE",
"ABOUT",
"ABOVE",
"ABROAD",
"ACCORDING",
"ACCORDINGLY",
"ACROSS",
"ACTUALLY",
"ADJ",
"AFTER",
"AFTERWARDS",
"AGAIN",
"AGAINST",
"AGO",
"AHEAD",
"AIN’T",
"ALL",
"ALLOW",
"ALLOWS",
"ALMOST",
"ALONE",
"ALONG",
"ALONGSIDE",
"ALREADY",
"ALSO",
"ALTHOUGH",
"ALWAYS",
"AM",
"AMID",
"AMIDST",
"AMONG",
"AMONGST",
"AN",
"AND",
"ANOTHER",
"ANY",
"ANYBODY",
"ANYHOW",
"ANYONE",
"ANYTHING",
"ANYWAY",
"ANYWAYS",
"ANYWHERE",
"APART",
"APPEAR",
"APPRECIATE",
"APPROPRIATE",
"ARE",
"AREN’T",
"AROUND",
"AS",
"A’S",
"ASIDE",
"ASK",
"ASKING",
"ASSOCIATED",
"AT",
"AVAILABLE",
"AWAY",
"AWFULLY",
"B",
"BACK",
"BACKWARD",
"BACKWARDS",
"BE",
"BECAME",
"BECAUSE",
"BECOME",
"BECOMES",
"BECOMING",
"BEEN",
"BEFORE",
"BEFOREHAND",
"BEGIN",
"BEHIND",
"BEING",
"BELIEVE",
"BELOW",
"BESIDE",
"BESIDES",
"BEST",
"BETTER",
"BETWEEN",
"BEYOND",
"BOTH",
"BRIEF",
"BUT",
"BY",
"C",
"CAME",
"CAN",
"CANNOT",
"CANT",
"CAN’T",
"CAPTION",
"CAUSE",
"CAUSES",
"CERTAIN",
"CERTAINLY",
"CHANGES",
"CLEARLY",
"C’MON",
"CO",
"CO.",
"COM",
"COME",
"COMES",
"CONCERNING",
"CONSEQUENTLY",
"CONSIDER",
"CONSIDERING",
"CONTAIN",
"CONTAINING",
"CONTAINS",
"CORRESPONDING",
"COULD",
"COULDN’T",
"COURSE",
"C’S",
"CURRENTLY",
"D",
"DARE",
"DAREN’T",
"DEFINITELY",
"DESCRIBED",
"DESPITE",
"DID",
"DIDN’T",
"DIFFERENT",
"DIRECTLY",
"DO",
"DOES",
"DOESN’T",
"DOING",
"DONE",
"DON’T",
"DOWN",
"DOWNWARDS",
"DURING",
"E",
"EACH",
"EDU",
"EG",
"EIGHT",
"EIGHTY",
"EITHER",
"ELSE",
"ELSEWHERE",
"END",
"ENDING",
"ENOUGH",
"ENTIRELY",
"ESPECIALLY",
"ET",
"ETC",
"EVEN",
"EVER",
"EVERMORE",
"EVERY",
"EVERYBODY",
"EVERYONE",
"EVERYTHING",
"EVERYWHERE",
"EX",
"EXACTLY",
"EXAMPLE",
"EXCEPT",
"F",
"FAIRLY",
"FAR",
"FARTHER",
"FEW",
"FEWER",
"FIFTH",
"FIRST",
"FIVE",
"FOLLOWED",
"FOLLOWING",
"FOLLOWS",
"FOR",
"FOREVER",
"FORMER",
"FORMERLY",
"FORTH",
"FORWARD",
"FOUND",
"FOUR",
"FROM",
"FURTHER",
"FURTHERMORE",
"G",
"GET",
"GETS",
"GETTING",
"GIVEN",
"GIVES",
"GO",
"GOES",
"GOING",
"GONE",
"GOT",
"GOTTEN",
"GREETINGS",
"H",
"HAD",
"HADN’T",
"HALF",
"HAPPENS",
"HARDLY",
"HAS",
"HASN’T",
"HAVE",
"HAVEN’T",
"HAVING",
"HE",
"HE’D",
"HE’LL",
"HELLO",
"HELP",

"HENCE",
"HER",
"HERE",
"HEREAFTER",
"HEREBY",
"HEREIN",
"HERE’S",
"HEREUPON",
"HERS",
"HERSELF",
"HE’S",
"HI",
"HIM",
"HIMSELF",
"HIS",
"HITHER",
"HOPEFULLY",
"HOW",
"HOWBEIT",
"HOWEVER",
"HUNDRED",
"I",
"I’D",
"IE",
"IF",
"IGNORED",
"I’LL",
"I’M",
"IMMEDIATE",
"IN",
"INASMUCH",
"INC",
"INC.",
"INDEED",
"INDICATE",
"INDICATED",
"INDICATES",
"INNER",
"INSIDE",
"INSOFAR",
"INSTEAD",
"INTO",
"INWARD",
"IS",
"ISN’T",
"IT",
"IT’D",
"IT’LL",
"ITS",
"IT’S",
"ITSELF",
"I’VE",
"J",
"JUST",
"K",
"KEEP",
"KEEPS",
"KEPT",
"KNOW",
"KNOWN",
"KNOWS",
"L",
"LAST",
"LATELY",
"LATER",
"LATTER",
"LATTERLY",
"LEAST",
"LESS",
"LEST",
"LET",
"LET’S",
"LIKE",
"LIKED",
"LIKELY",
"LIKEWISE",
"LITTLE",
"LOOK",
"LOOKING",
"LOOKS",
"LOW",
"LOWER",
"LTD",
"M",
"MADE",
"MAINLY",
"MAKE",
"MAKES",
"MANY",
"MAY",
"MAYBE",
"MAYN’T",
"ME",
"MEAN",
"MEANTIME",
"MEANWHILE",
"MERELY",
"MIGHT",
"MIGHTN’T",
"MINE",
"MINUS",
"MISS",
"MORE",
"MOREOVER",
"MOST",
"MOSTLY",
"MR",
"MRS",
"MUCH",
"MUST",
"MUSTN’T",
"MY",
"MYSELF",
"N",
"NAME",
"NAMELY",
"ND",
"NEAR",
"NEARLY",
"NECESSARY",
"NEED",
"NEEDN’T",
"NEEDS",
"NEITHER",
"NEVER",
"NEVERF",
"NEVERLESS",
"NEVERTHELESS",
"NEW",
"NEXT",
"NINE",
"NINETY",
"NO",
"NOBODY",
"NON",
"NONE",
"NONETHELESS",
"NOONE",
"NO-ONE",
"NOR",
"NORMALLY",
"NOT",
"NOTHING",
"NOTWITHSTANDING",
"NOVEL",
"NOW",
"NOWHERE",
"O",
"OBVIOUSLY",
"OF",
"OFF",
"OFTEN",
"OH",
"OK",
"OKAY",
"OLD",
"ON",
"ONCE",
"ONE",
"ONES",
"ONE’S",
"ONLY",
"ONTO",
"OPPOSITE",
"OR",
"OTHER",
"OTHERS",
"OTHERWISE",
"OUGHT",
"OUGHTN’T",
"OUR",
"OURS",
"OURSELVES",
"OUT",
"OUTSIDE",
"OVER",
"OVERALL",
"OWN",
"P",
"PARTICULAR",
"PARTICULARLY",
"PAST",
"PER",
"PERHAPS",
"PLACED",
"PLEASE",
"PLUS",
"POSSIBLE",
"PRESUMABLY",
"PROBABLY",
"PROVIDED",
"PROVIDES",
"Q",
"QUE",
"QUITE",
"QV",
"R",
"RATHER",
"RD",
"RE",
"REALLY",
"REASONABLY",
"RECENT",
"RECENTLY",
"REGARDING",
"REGARDLESS",
"REGARDS",
"RELATIVELY",
"RESPECTIVELY",
"RIGHT",
"ROUND",
"S",
"SAID",
"SAME",
"SAW",
"SAY",
"SAYING",
"SAYS",
"SECOND",
"SECONDL",

"SEE",
"SEEING",
"SEEM",
"SEEMED",
"SEEMING",
"SEEMS",
"SEEN",
"SELF",
"SELVES",
"SENSIBLE",
"SENT",
"SERIOUS",
"SERIOUSLY",
"SEVEN",
"SEVERAL",
"SHALL",
"SHAN’T",
"SHE",
"SHE’D",
"SHE’LL",
"SHE’S",
"SHOULD",
"SHOULDN’T",
"SINCE",
"SIX",
"SO",
"SOME",
"SOMEBODY",
"SOMEDAY",
"SOMEHOW",
"SOMEONE",
"SOMETHING",
"SOMETIME",
"SOMETIMES",
"SOMEWHAT",
"SOMEWHERE",
"SOON",
"SORRY",
"SPECIFIED",
"SPECIFY",
"SPECIFYING",
"STILL",
"SUB",
"SUCH",
"SUP",
"SURE",
"T",
"TAKE",
"TAKEN",
"TAKING",
"TELL",
"TENDS",
"TH",
"THAN",
"THANK",
"THANKS",
"THANX",
"THAT",
"THAT’LL",
"THATS",
"THAT’S",
"THAT’VE",
"THE",
"THEIR",
"THEIRS",
"THEM",
"THEMSELVES",
"THEN",
"THENCE",
"THERE",
"THEREAFTER",
"THEREBY",
"THERE’D",
"THEREFORE",
"THEREIN",
"THERE’LL",
"THERE’RE",
"THERES",
"THERE’S",
"THEREUPON",
"THERE’VE",
"THESE",
"THEY",
"THEY’D",
"THEY’LL",
"THEY’RE",
"THEY’VE",
"THING",
"THINGS",
"THINK",
"THIRD",
"THIRTY",
"THIS",
"THOROUGH",
"THOROUGHLY",
"THOSE",
"THOUGH",
"THREE",
"THROUGH",
"THROUGHOUT",
"THRU",
"THUS",
"TILL",
"TO",
"TOGETHER",
"TOO",
"TOOK",
"TOWARD",
"TOWARDS",
"TRIED",
"TRIES",
"TRULY",
"TRY",
"TRYING",
"T’S",
"TWICE",
"TWO",
"U",
"UN",
"UNDER",
"UNDERNEATH",
"UNDOING",
"UNFORTUNATELY",
"UNLESS",
"UNLIKE",
"UNLIKELY",
"UNTIL",
"UNTO",
"UP",
"UPON",
"UPWARDS",
"US",
"USE",
"USED",
"USEFUL",
"USES",
"USING",
"USUALLY",
"V",
"VALUE",
"VARIOUS",
"VERSUS",
"VERY",
"VIA",
"VIZ",
"VS",
"W",
"WANT",
"WANTS",
"WAS",
"WASN’T",
"WAY",
"WE",
"WE’D",
"WELCOME",
"WELL",
"WE’LL",
"WENT",
"WERE",
"WE’RE",
"WEREN’T",
"WE’VE",
"WHAT",
"WHATEVER",
"WHAT’LL",
"WHAT’S",
"WHAT’VE",
"WHEN",
"WHENCE",
"WHENEVER",
"WHERE",
"WHEREAFTER",
"WHEREAS",
"WHEREBY",
"WHEREIN",
"WHERE’S",
"WHEREUPON",
"WHEREVER",
"WHETHER",
"WHICH",
"WHICHEVER",
"WHILE",
"WHILST",
"WHITHER",
"WHO",
"WHO’D",
"WHOEVER",
"WHOLE",
"WHO’LL",
"WHOM",
"WHOMEVER",
"WHO’S",
"WHOSE",
"WHY",
"WILL",
"WILLING",
"WISH",
"WITH",
"WITHIN",
"WITHOUT",
"WONDER",
"WON’T",
"WOULD",
"WOULDN’T",
"X",
"Y",
"YES",
"YET",
"YOU",
"YOU’D",
"YOU’LL",
"YOUR",
"YOU’RE",
"YOURS",
"YOURSELF",
"YOURSELVES",
"YOU’VE",
"Z",
"ZERO"]